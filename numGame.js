// Generated by CoffeeScript 1.3.3
var Box, CanvasState, Cell, Dcell, getRamdomNumbers, htmlHeight, init, noOfItems,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

noOfItems = 6;

htmlHeight = "";

Array.prototype.remove = function(e) {
  var t, _ref;
  if ((t = this.indexOf(e)) > -1) {
    return ([].splice.apply(this, [t, t - t + 1].concat(_ref = [])), _ref);
  }
};

Array.prototype.pushUnique = function(a, e) {
  if (__indexOf.call(a, e) < 0) {
    return a.push(e);
  }
};

Box = (function() {

  function Box(x, y, w, h, colour, data) {
    this.x = x;
    this.y = y;
    this.w = w;
    this.h = h;
    this.colour = colour;
    this.data = data;
    this.active = false;
  }

  Box.prototype.contains = function(mx, my) {
    return (this.x <= mx && mx <= (this.x + this.w)) && (this.y <= my && my <= (this.y + this.h));
  };

  return Box;

})();

Cell = (function(_super) {

  __extends(Cell, _super);

  function Cell() {
    return Cell.__super__.constructor.apply(this, arguments);
  }

  Cell.Dcell;

  Cell.prototype.draw = function(ctx) {
    ctx.fillStyle = this.colour;
    ctx.fillRect(this.x, this.y, this.w, this.h);
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'green';
    return ctx.strokeRect(this.x, this.y, this.w, this.h);
  };

  return Cell;

})(Box);

Dcell = (function(_super) {

  __extends(Dcell, _super);

  function Dcell() {
    return Dcell.__super__.constructor.apply(this, arguments);
  }

  Dcell.prototype.draw = function(ctx) {
    ctx.fillStyle = this.colour;
    ctx.fillRect(this.x, this.y, this.w, this.h);
    ctx.font = "20pt Calibri";
    ctx.fillStyle = 'white';
    return ctx.fillText(this.data, this.x + this.w / 4, this.y + 35);
  };

  return Dcell;

})(Box);

CanvasState = (function() {

  function CanvasState(canvas) {
    var myState;
    this.canvas = canvas;
    this.width = canvas.width;
    this.height = canvas.height;
    this.ctx = canvas.getContext('2d');
    myState = this;
    this.Cells = [];
    this.Dcells = [];
    this.playAgainBox = new Box(this.width - 120, 10, 100, 30, "green", "Play Again");
    this.resetBox = new Box(this.width - 220, 10, 70, 30, "green", "Reset");
    this.sortBox = new Box(this.width - 400, 10, 120, 30, "Red", "Acending");
    this.stylePaddingLeft;
    this.stylePaddingTop;
    this.styleBorderLeft;
    this.styleBorderTop;
    myState.dragging = false;
    myState.sort = "Acending";
    if (document.defaultView && document.defaultView.getComputedStyle) {
      this.stylePaddingLeft = parseInt(document.defaultView.getComputedStyle(canvas, null)['paddingLeft'], 10) || 0;
      this.stylePaddingTop = parseInt(document.defaultView.getComputedStyle(canvas, null)['paddingTop'], 10) || 0;
      this.styleBorderLeft = parseInt(document.defaultView.getComputedStyle(canvas, null)['borderLeftWidth'], 10) || 0;
      this.styleBorderTop = parseInt(document.defaultView.getComputedStyle(canvas, null)['borderTopWidth'], 10) || 0;
    }
    this.complete = "false";
    this.tryAgain = "false";
    this.selectionColor = '#CC0000';
    this.selectionWidth = 2;
    this.interval = 30;
    setInterval(function() {
      return myState.draw();
    }, myState.interval);
    canvas.addEventListener('mousedown', function(e) {
      return myState.pressAction(myState, e, "mouse");
    }, true);
    canvas.addEventListener('mousemove', function(e) {
      return myState.moveAction(myState, e, "mouse");
    }, true);
    canvas.addEventListener('mouseup', function(e) {
      return myState.releaseAction(myState, e, "mouse");
    }, true);
    canvas.addEventListener('mouseout', function(e) {
      return myState.releaseAction(myState, e, "mouse");
    }, true);
    canvas.addEventListener('touchstart', function(e) {
      return myState.pressAction(myState, e, "touch");
    }, true);
    canvas.addEventListener('touchmove', function(e) {
      return myState.moveAction(myState, e, "touch");
    }, true);
    canvas.addEventListener('touchend', function(e) {
      return myState.releaseAction(myState, e, "touch");
    }, true);
    canvas.addEventListener('touchcancel', function(e) {
      return myState.releaseAction(myState, e, "touch");
    }, true);
  }

  CanvasState.prototype.pressAction = function(myState, e, moveBy) {
    var dcell, dcells, i, mouse, mx, my, seletedBox, _i, _ref;
    mouse = moveBy === "mouse" ? myState.getMouse(e) : myState.getTouch(e);
    mx = mouse.x;
    my = mouse.y;
    dcells = myState.Dcells;
    for (i = _i = _ref = dcells.length - 1; _i >= 0; i = _i += -1) {
      dcell = dcells[i];
      if (dcell.contains(mx, my)) {
        myState.tryAgain = "false";
        seletedBox = dcell;
        dcells.remove(dcell);
        dcells.push(dcell);
        myState.dragoffx = mx - seletedBox.x;
        myState.dragoffy = my - seletedBox.y;
        myState.dragging = true;
        myState.selection = seletedBox;
        myState.valid = false;
        return;
      }
    }
    if (myState.selection) {
      myState.selection = null;
      return myState.valid = false;
    }
  };

  CanvasState.prototype.moveAction = function(myState, e, moveBy) {
    var mouse;
    if (myState.dragging) {
      mouse = moveBy === "mouse" ? myState.getMouse(e) : myState.getTouch(e);
      myState.selection.x = mouse.x - myState.dragoffx;
      myState.selection.y = mouse.y - myState.dragoffy;
      return myState.valid = false;
    }
  };

  CanvasState.prototype.releaseAction = function(myState, e, moveBy) {
    var cell, cells, dcell, dcells, flag, i, j, mouse, mx, my, _i, _j, _ref, _ref1;
    myState.dragging = false;
    mouse = moveBy === "mouse" ? myState.getMouse(e) : myState.getTouch(e);
    mx = mouse.x;
    my = mouse.y;
    if (myState.playAgainBox.contains(mx, my)) {
      return myState.reloadGame();
    }
    if (myState.resetBox.contains(mx, my)) {
      return myState.resetGame();
    }
    if (myState.sortBox.contains(mx, my)) {
      return myState.changeSortOrder(myState);
    }
    flag = true;
    dcells = myState.Dcells;
    cells = myState.Cells;
    for (i = _i = _ref = cells.length - 1; _i >= 0; i = _i += -1) {
      flag = true;
      cell = cells[i];
      for (j = _j = 0, _ref1 = dcells.length - 1; 0 <= _ref1 ? _j <= _ref1 : _j >= _ref1; j = 0 <= _ref1 ? ++_j : --_j) {
        dcell = dcells[j];
        if (myState.checkifIn(cell, dcell)) {
          if (cell.Dcell) {
            cell.Dcell.y = cell.Dcell.y - 70;
          }
          dcell.x = cell.x + 5;
          dcell.y = cell.y + 5;
          myState.Cells[i].Dcell = dcell;
          flag = false;
        }
      }
      if (flag && cell.Dcell) {
        myState.Cells[i].Dcell = "";
      }
    }
    return myState.checkAscending(myState.Cells, myState);
  };

  CanvasState.prototype.clear = function() {
    this.ctx.clearRect(0, 0, this.width, this.height);
  };

  CanvasState.prototype.addCell = function(Cell) {
    this.Cells.push(Cell);
    this.valid = false;
  };

  CanvasState.prototype.addDCell = function(Dcell) {
    this.Dcells.push(Dcell);
    this.valid = false;
  };

  CanvasState.prototype.draw = function() {
    var cell, ctx, dcell, gradient1, mySel, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
    ctx = this.ctx;
    this.clear();
    gradient1 = ctx.createLinearGradient(0, 0, 0, 300);
    gradient1.addColorStop(0, "#00ABEB");
    gradient1.addColorStop(1, "white");
    ctx.fillStyle = gradient1;
    ctx.fillRect(0, 0, this.width, this.height);
    ctx.fillStyle = this.playAgainBox.colour;
    ctx.fillRect(this.playAgainBox.x, this.playAgainBox.y, this.playAgainBox.w, this.playAgainBox.h);
    ctx.font = "15pt Calibri";
    ctx.fillStyle = 'white';
    ctx.fillText(this.playAgainBox.data, this.playAgainBox.x + 10, this.playAgainBox.h);
    if (this.complete === "false") {
      ctx.fillStyle = this.resetBox.colour;
      ctx.fillRect(this.resetBox.x, this.resetBox.y, this.resetBox.w, this.resetBox.h);
      ctx.font = "15pt Calibri";
      ctx.fillStyle = 'white';
      ctx.fillText(this.resetBox.data, this.resetBox.x + 10, this.resetBox.h);
    }
    ctx.fillStyle = this.sortBox.colour;
    ctx.fillRect(this.sortBox.x, this.sortBox.y, this.sortBox.w, this.sortBox.h);
    ctx.font = "15pt Calibri";
    ctx.fillStyle = 'white';
    ctx.fillText(this.sortBox.data, this.sortBox.x + 10, this.sortBox.h);
    if (this.complete === "true") {
      _ref = this.Cells;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        cell = _ref[_i];
        if ((cell.x - 1 + this.width) > this.canvas.offsetLeft) {
          cell.x = cell.x - 1;
          cell.Dcell.x = cell.Dcell.x - 1;
        }
        cell.draw(ctx);
        cell.Dcell.draw(ctx);
        ctx.fillStyle = "yellow";
        ctx.font = "25pt Calibri";
        ctx.fillText("Congrats you won !!", 20, 130);
      }
    } else {
      _ref1 = this.Cells;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        cell = _ref1[_j];
        cell.draw(ctx);
      }
      _ref2 = this.Dcells;
      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
        dcell = _ref2[_k];
        dcell.draw(ctx);
      }
      if (this.selection) {
        ctx.strokeStyle = this.selectionColor;
        ctx.lineWidth = this.selectionWidth;
        mySel = this.selection;
        ctx.strokeRect(mySel.x, mySel.y, mySel.w, mySel.h);
      }
    }
    if (this.tryAgain === "true") {
      ctx.fillStyle = "yellow";
      ctx.font = "25pt Calibri";
      return ctx.fillText("Wrong Try Again", 20, 130);
    }
  };

  CanvasState.prototype.getMouse = function(e) {
    var element, mx, my, offsetX, offsetY;
    element = this.canvas;
    offsetX = 0;
    offsetY = 0;
    if (element.offsetParent !== void 0) {
      while (true) {
        offsetX += element.offsetLeft;
        offsetY += element.offsetTop;
        if ((element = element.offsetParent)) {
          break;
        }
      }
    }
    offsetX += this.stylePaddingLeft + this.styleBorderLeft;
    offsetY += this.stylePaddingTop + this.styleBorderTop;
    mx = e.pageX - offsetX;
    my = e.pageY - offsetY;
    return {
      x: mx,
      y: my
    };
  };

  CanvasState.prototype.getTouch = function(e) {
    var element, mx, my, offsetX, offsetY;
    e.preventDefault();
    element = this.canvas;
    offsetX = 0;
    offsetY = 0;
    if (element.offsetParent !== void 0) {
      while (true) {
        offsetX += element.offsetLeft;
        offsetY += element.offsetTop;
        if ((element = element.offsetParent)) {
          break;
        }
      }
    }
    offsetX += this.stylePaddingLeft + this.styleBorderLeft;
    offsetY += this.stylePaddingTop + this.styleBorderTop;
    mx = e.targetTouches[0].pageX - offsetX;
    my = e.targetTouches[0].pageY - offsetY;
    return {
      x: mx,
      y: my
    };
  };

  CanvasState.prototype.checkifIn = function(box1, box2) {
    return Math.abs(box1.x - box2.x) <= 30 && Math.abs(box1.y - box2.y) <= 30;
  };

  CanvasState.prototype.getCellValues = function(Cells) {
    var cell, values, _i, _len;
    values = [];
    for (_i = 0, _len = Cells.length; _i < _len; _i++) {
      cell = Cells[_i];
      if (cell.Dcell !== void 0 && cell.Dcell !== "") {
        values.push(cell.Dcell.data);
      }
    }
    return values;
  };

  CanvasState.prototype.checkSort = function(values, myState) {
    var i, isSorted, _i, _ref;
    isSorted = false;
    for (i = _i = 0, _ref = values.length - 2; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
      if (myState.sort === "Acending" && parseInt(values[i]) < parseInt(values[i + 1])) {
        isSorted = true;
      } else if (myState.sort === "Decending" && parseInt(values[i]) > parseInt(values[i + 1])) {
        isSorted = true;
      } else {
        isSorted = false;
        break;
      }
    }
    if (isSorted) {
      this.complete = "true";
    } else {
      this.tryAgain = "true";
    }
    return isSorted;
  };

  CanvasState.prototype.checkAscending = function(Cells, myState) {
    var values;
    values = this.getCellValues(Cells);
    if (values.length === noOfItems) {
      return this.checkSort(values, myState);
    }
    return false;
  };

  CanvasState.prototype.changeSortOrder = function(myState) {
    this.tryAgain = "false";
    if (myState.sort === "Acending") {
      myState.sort = "Decending";
      myState.sortBox.data = "Decending";
      return myState.checkAscending(myState.Cells, myState);
    } else {
      myState.sort = "Acending";
      myState.sortBox.data = "Acending";
      return myState.checkAscending(myState.Cells, myState);
    }
  };

  CanvasState.prototype.resetGame = function() {
    var i, x, _i, _ref, _results;
    this.tryAgain = "false";
    if (this.complete === "false") {
      x = 20;
      _results = [];
      for (i = _i = 0, _ref = noOfItems - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        this.Cells[i].x = x;
        this.Cells[i].y = htmlHeight - 100;
        this.Dcells[i].x = x;
        this.Dcells[i].y = htmlHeight - 200;
        this.Cells.Dcell = "";
        _results.push(x += 100);
      }
      return _results;
    }
  };

  CanvasState.prototype.reloadGame = function() {
    var i, randomNums, x, _i, _ref, _results;
    x = 20;
    this.complete = "false";
    this.tryAgain = "false";
    randomNums = getRamdomNumbers(noOfItems);
    _results = [];
    for (i = _i = 0, _ref = noOfItems - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
      this.Cells[i].x = x;
      this.Cells[i].y = htmlHeight - 100;
      this.Dcells[i].x = x;
      this.Dcells[i].y = htmlHeight - 200;
      this.Dcells[i].data = randomNums[i];
      this.Cells.Dcell = "";
      _results.push(x += 100);
    }
    return _results;
  };

  return CanvasState;

})();

getRamdomNumbers = function(count) {
  var flag, index, randomNum, randomNums;
  randomNums = [];
  index = 0;
  flag = true;
  while (randomNums.length < count) {
    randomNum = Math.floor(Math.random() * 100);
    if (randomNum !== 'undefined' && (0 < randomNum && randomNum < 100)) {
      randomNums.push(randomNum);
      randomNums.pushUnique(randomNums, randomNum);
    }
  }
  return randomNums;
};

init = function() {
  var cs, i, parent, randomNums, x, _i, _ref;
  parent = document.getElementById('canvas1');
  htmlHeight = parent.offsetHeight;
  randomNums = getRamdomNumbers(noOfItems);
  cs = new CanvasState(document.getElementById('canvas1'));
  x = 20;
  for (i = _i = 0, _ref = noOfItems - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
    cs.addCell(new Cell(x, htmlHeight - 100, 60, 60, 'grey'));
    cs.addDCell(new Dcell(x, htmlHeight - 200, 50, 50, 'brown', randomNums[i]));
    x += 100;
  }
};
